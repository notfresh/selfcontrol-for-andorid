## 专注时间统计方案

### 1. 数据记录

#### 1.1 时间记录点
- 开始时间：`BlockerService.onStartCommand()` 时记录开始时间戳（`System.currentTimeMillis()`）
- 结束时间：`BlockerService.onDestroy()` 或用户主动停止时记录结束时间戳
- 计算时长：`结束时间 - 开始时间 = 本次专注时长（毫秒级别）`

#### 1.2 数据存储
- 使用 `SharedPreferences` 存储：
  - `current_session_start_time`：当前会话开始时间戳
  - `current_session_duration`：当前会话已持续时长（实时更新）
  - `total_focus_time_today`：今日累计专注时长（毫秒）
  - `total_focus_time_week`：本周累计专注时长（毫秒）
  - `last_focus_duration`：上次专注时长（用于显示）

### 2. 实时更新机制

#### 2.1 更新频率
- 使用 `Handler.postDelayed()` 或 `CountDownTimer` 每秒更新一次
- 在 `BlockerService` 中维护定时器，每秒：
  1. 计算当前已专注时长：`当前时间 - 开始时间`
  2. 更新 `current_session_duration`

#### 2.2 更新时机
- 服务运行期间：每分钟更新
- 用户打开 `MainActivity`：实时显示当前时长
- 通知栏：显示当前专注时长（可选）

### 3. UI 展示方案

#### 3.1 MainActivity 显示
- 专注模式运行中时：
  - 状态文本显示：
    ```
    专注模式运行中
    本次专注：XX 分 
    今日累计：XX 小时 XX 分钟
    ```
  - 使用 `TextView` 实时更新（`onResume()` 时刷新）

#### 3.2 停止前确认对话框
- 用户点击“停止专注模式”时：
  - 先弹出确认对话框，显示：
    ```
    确定要结束专注模式吗？
    
    本次专注时长：XX 分 XX 秒
    今日累计时长：XX 小时 XX 分钟
    
    继续专注 / 结束专注
    ```
  - 提供“继续专注”和“结束专注”两个按钮

### 4. 实现细节

#### 4.1 时间格式化
- 将毫秒转换为可读格式：
  - `< 1分钟`：显示“XX 秒”
  - `< 1小时`：显示“XX 分 XX 秒”
  - `>= 1小时`：显示“X 小时 XX 分”

#### 4.2 跨天处理
- 检测日期变化：
  - `onResume()` 时检查日期
  - 如果日期变化，重置今日累计时长
  - 保留历史数据（本周累计）

#### 4.3 服务重启处理
- 如果服务异常重启：
  - 从 `SharedPreferences` 读取 `current_session_start_time`
  - 如果时间戳存在且合理（如不超过24小时），继续计算
  - 否则重置为新会话

### 5. 数据流程

```
启动专注模式
    ↓
记录开始时间戳 → SharedPreferences
    ↓
服务运行中
    ↓
每秒更新：当前时长 = 当前时间 - 开始时间
    ↓
用户查看 MainActivity → 显示实时时长
    ↓
用户点击停止
    ↓
显示确认对话框（本次时长 + 今日累计）
    ↓
用户确认停止
    ↓
计算最终时长 → 更新今日累计 → 保存历史记录
    ↓
停止服务
```

### 6. 用户体验优化

#### 6.1 心理准备
- 停止前显示本次时长，帮助评估
- 显示今日累计，提供成就感
- 可设置目标时长，显示进度（如“今日目标：2小时，已完成：1.5小时”）

### 7. 技术要点

#### 7.1 性能考虑
- 每秒更新 UI 可能频繁，可改为每5秒更新一次
- 使用 `Handler.postDelayed()` 而非 `Timer`
- `SharedPreferences` 读写频率适中，避免频繁写入

#### 7.2 数据一致性
- 服务与 Activity 通过 `SharedPreferences` 共享数据
- 使用 `apply()` 而非 `commit()`（异步写入）
- 关键数据（如停止时）使用 `commit()` 确保立即保存

#### 7.3 边界情况
- 应用被杀死：从 `SharedPreferences` 恢复开始时间
- 系统时间被修改：使用相对时间而非绝对时间
- 多设备同步：如需同步，考虑使用数据库或云端存储

### 8. 实现优先级

- 高优先级：
  1. 记录开始时间
  2. 实时计算并显示当前专注时长
  3. 停止前显示本次时长确认
- 中优先级：
  4. 今日累计时长统计
  5. 通知栏显示时长
- 低优先级：
  6. 历史统计页面
  7. 成就系统
  8. 目标设置

该方案可在不增加复杂度的情况下，提供清晰的专注时长反馈，帮助用户评估和坚持。